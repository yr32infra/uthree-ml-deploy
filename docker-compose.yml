version: '3.9'
services:
  squid:
    image: ubuntu/squid:5.2-22.04_beta@sha256:7009921603f1d67ac4b33e2b1e0ee41a85bd033f86a1f2c198d9b53e803393d8
    hostname: squid
    container_name: uthreeml__squid
    restart: unless-stopped

    volumes:
      - type: bind
        source: ./squid.conf
        target: /etc/squid/squid.conf
        read_only: true

    networks:
      - default
      - outband

    deploy:
      resources:
        limits:
          memory: 256m

  jupyternotebook:
    build: https://github.com/yanorei32/uthree-ml-image.git#v0.7.3
    hostname: jupyternotebook
    container_name: uthreeml__jupyternotebook
    restart: unless-stopped
    init: true

    environment:
      SHELL: "/bin/zsh"
      http_proxy: http://squid:3128
      https_proxy: http://squid:3128

    volumes:
      - type: volume
        source: workdir
        target: /root

    networks:
      - default

    deploy:
      resources:
        limits:
          memory: 16g
        reservations:
          devices:
            - driver: nvidia
              capabilities: [gpu]

  cloudflared:
    image: cloudflare/cloudflared:2023.7.3-amd64@sha256:551fbcfb9f76b8dbac397c55f468cfe3b09e0f4332f355118b4f5d904d66c028
    hostname: cloudflared
    container_name: uthreeml__cloudflared
    restart: unless-stopped

    environment:
      TUNNEL_METRICS: 0.0.0.0:9126
      TUNNEL_LOGFILE: /dev/stdout

    command: tunnel run --token ${TUNNEL_TOKEN}
    user: root

    networks:
      default:
      outband:
      prometheus__cloudflared:
        aliases:
          - uthreeml__cloudflared

    deploy:
      resources:
        limits:
          memory: 128m

volumes:
  workdir:
    name: uthreeml__workdir

networks:
  prometheus__cloudflared:
    name: prometheus__cloudflared
    external: true

  default:
    name: uthreeml__default
    internal: true

  outband:
    name: uthreeml__outband
